package visualRecognitionTest;

import java.util.ArrayList;

import generalpurpose.gpExecBatch;
import generalpurpose.gpPrintStream;
import generalpurpose.gpUtils;

import javax.swing.JTextField;
import javax.swing.SwingWorker;


public class visualRecognitionController extends SwingWorker<Integer, Integer> {

	private gpUtils xU = null;
	private gpPrintStream sout = null;
	
	JTextField textField = null;   // is used as a callback
	private boolean isOK = true;
	private String application=null;
	private String currentImageFileName=null;
	private String ScriptName = null;
	private String OutputName = null;
	
	private String WatsonScriptFolder = null;
	private String TensorScriptFolder = null;
	private String APIKey = null;
	private String ClassifierId = null;
	
	//---------------------------------------------------------------------------------
	public void setScriptName(String sin)
	{
		ScriptName = sin.trim();
	}
	public void setOutputName(String sin)
	{
		OutputName = sin.trim();
	}
	public void setApplciation(String sin)
	{
		application = sin.trim();
	}
	public void setWatsonScriptFolder(String sin)
	{
		WatsonScriptFolder=sin;
	}
	public void setTensorScriptFolder(String sin)
	{
		TensorScriptFolder=sin;
	}
	public void setAPIKey(String sin)
	{
		APIKey=sin;
	}
	public void setImageName(String sin)
	{
		currentImageFileName=sin;
	}
	public void setClassifierId(String sin)
	{
		ClassifierId = sin;
	}
	
	//---------------------------------------------------------------------------------
	public visualRecognitionController (JTextField it)
	//---------------------------------------------------------------------------------
	{
		textField = it;
		xU = new gpUtils();
	}
	
	@Override
	//---------------------------------------------------------------------------------
	protected Integer doInBackground() throws Exception
	//---------------------------------------------------------------------------------
    {
		 if( ScriptName == null ) {
			 isOK=false;
			 System.err.println("Scriptname has not been set");
			 return -1;
		 }
		 if( OutputName == null) {
			 isOK=false;
			 System.err.println("Outputname has not been set");
			 return -1;
		 }
		 if( currentImageFileName == null) {
			 isOK=false;
			 System.err.println("ImageFileName has not been set");
			 return -1;
		 }
		 if( application == null) {
			 isOK=false;
			 System.err.println("Application has not been set");
			 return -1;
		 }
		 //
		 System.out.println("Scriptname         [" + ScriptName + "]" );
		 System.out.println("OutputName         [" + OutputName + "]" );
		 System.out.println("Image              [" + currentImageFileName + "]" );
		 System.out.println("Application        [" + application + "]" );
		 System.out.println("Key                [" + APIKey + "]" );
		 System.out.println("WatsonScriptFolder [" + WatsonScriptFolder + "]" );
		 System.out.println("TensorFolder       [" + TensorScriptFolder + "]" );
		 System.out.println("ClassifierId       [" + ClassifierId + "]");
		 //
	     if( application.compareToIgnoreCase("WATSON") == 0) isOK = do_watson();
	     else
	     if( application.compareToIgnoreCase("TENSORFLOW") == 0) isOK = do_tensorflow();
	     else isOK = false;	 
	     if( isOK ) {
	    	isOK = runscript();
	     }
		return 0;
    }
	
	@Override
	//---------------------------------------------------------------------------------
	protected void done()
	//---------------------------------------------------------------------------------
	{
		 if (!this.isCancelled()) {
	            System.out.println("Swingworker stopped [" + application + "]");
			    if( isOK ) textField.setText("Done"); else textField.setText("Error");
	     }
	}
	
	
	
	//---------------------------------------------------------------------------------
	private boolean do_watson()
	//---------------------------------------------------------------------------------
	{
		if( removeoutput() == false ) return false;
		if( imageExists() == false ) return false;
		if( removescript() == false ) return false;
		if( createscript() == false ) return false;
		//  text
		if( xU.ctSlash == '/')        {
			sout.println( "# Generated by visualRecognitionTest" );
			sout.println( "# " + xU.prntDateTime(System.currentTimeMillis(),"dd-MMM HH:mm:SS"));
			sout.println( "cd " + WatsonScriptFolder );
            sout.println( 
            	    "curl -X POST -F \"images_file=@" + 
            		currentImageFileName + 
            		"\" -F \"parameters=@watsonparam.json\"  " + 
            		"\"https://gateway-a.watsonplatform.net/visual-recognition/api/v3/classify?api_key=" +
            		APIKey + 
            		"&version=2016-12-01\""
                    );
           createParamFile();
		}
		else {
		 sout.println( "REM " + currentImageFileName );
		 sout.println( "DIR" );
		}
		//
		return closescript();
	}
	
	
	private boolean createParamFile()
	{
		String FileName =  WatsonScriptFolder + "/watsonparam.json";
        gpPrintStream gp = new gpPrintStream(FileName,"ASCII");
        gp.println("{");
        gp.println("\"classifier_ids\" : [\"" + ClassifierId + "\",\"default\"]");
        gp.println("}");
        gp.close();
		return true;
	}
	
	//---------------------------------------------------------------------------------
	private boolean do_tensorflow()
	//---------------------------------------------------------------------------------
	{
		if( removeoutput() == false ) return false;
		if( imageExists() == false ) return false;
		if( removescript() == false ) return false;
		if( createscript() == false ) return false;
		//
		if( xU.ctSlash == '/')        {
			sout.println( "# Generated by visualRecognitionTest" );
			sout.println( "# " + xU.prntDateTime(System.currentTimeMillis(),"dd-MMM HH:mm:SS"));
			sout.println( "cd " + TensorScriptFolder );
			sout.println( "python3 ./test_image.py " + currentImageFileName );
		}
		else {
		 sout.println( "REM " + currentImageFileName );
		 sout.println( "ver" );
		}
		//
		return closescript();
	}
	
	//---------------------------------------------------------------------------------
	private boolean imageExists()
	//---------------------------------------------------------------------------------
	{
		boolean ib = xU.IsBestand(currentImageFileName);
		if( ib == false ) System.err.println("Cannot locate image file [" + currentImageFileName + "]");
		return ib;
	}
	
	//---------------------------------------------------------------------------------
	private boolean removeoutput()
	//---------------------------------------------------------------------------------
	{
			if( xU.IsBestand(OutputName) ) {
				xU.VerwijderBestand(OutputName);
				if( xU.IsBestand(OutputName) ) {
					System.err.println("Cannot remove output [" + OutputName + "]");
					return false;
				}
			}
			return true;
	}
		
	//---------------------------------------------------------------------------------
	private boolean removescript()
	//---------------------------------------------------------------------------------
	{
		if( xU.IsBestand(ScriptName) ) {
			xU.VerwijderBestand(ScriptName);
			if( xU.IsBestand(ScriptName) ) {
				System.err.println("Cannot remove script [" + ScriptName + "]");
				return false;
			}
		}
		return true;
	}
	
	//---------------------------------------------------------------------------------
	private boolean createscript()
	//---------------------------------------------------------------------------------
	{
		sout = new gpPrintStream(ScriptName , "ASCII");
		return sout.isActive();
	}
	
	//---------------------------------------------------------------------------------
	private boolean closescript()
    //---------------------------------------------------------------------------------
	{
		boolean ib = sout.close();
		sout = null;
		return ib;
	}
	
	//---------------------------------------------------------------------------------
	private boolean runscript()
	//---------------------------------------------------------------------------------
	{
	   if( xU.IsBestand(ScriptName) == false ) return false;
	   gpExecBatch bat = new gpExecBatch(ScriptName);
	   int level = bat.getExitLevel();
	   if( level != 0 ) {
		   System.err.println("OS Exit level [" + level + "]  -> Error");
		   bat=null;
		   return false;
	   }
	   //   
	   if( removeoutput() == false ) return false;
	   //
	   sout = new gpPrintStream(OutputName , "ASCII");
	   if( sout.isActive() == false ) {
		   System.err.println("cannot open for write [" + OutputName + "]");
		   bat = null;
		   sout = null;
		   return false;
	   }
	   //
	   ArrayList<String> l = bat.getSTDOUT();
	   sout.println("=> stdout [" + l.size() + "]");
	   for(int i=0;i<l.size();i++)
	   {
		   sout.println(l.get(i));
	   }
	   //
	   sout.println("");
	   l = bat.getSTDERR();
	   sout.println("=> stderr [" + l.size() + "]");
	   for(int i=0;i<l.size();i++)
	   {
		   sout.println(l.get(i));
	   }
	   //
	   boolean ib = sout.close();
	   sout = null;
	   bat = null;
	   return ib;
    }
}
